@startuml Booking 
' Sơ đồ Tuần tự Hoàn Chỉnh - Usecase "Đặt Sân"
' Phiên bản ĐÃ SỬA LỖI, có cấu trúc và chú thích chi tiết

title Sơ đồ Tuần tự - Usecase "Đặt Sân"

' --- Cấu hình & Định nghĩa các Thành phần ---
autonumber "<b>[0]"

actor ":Thành viên" as Member
participant ":BookingController" as BController
participant ":BookingService" as BService
participant ":FieldService" as FService
participant ":PaymentService" as PService
participant ":NotificationService" as NotiService
participant ":Database" as DB
actor ":Hệ thống thanh toán" as PaymentGateway

skinparam sequenceActorBorderColor #5E81AC
skinparam sequenceParticipantBorderColor #5E81AC
skinparam sequenceLifeLineBorderColor #BF616A


' --- Bắt đầu luồng nghiệp vụ ---

group Luồng Khách hàng Khởi tạo Đặt sân

    Member -> BController: Yêu cầu đặt sân (POST /bookings)
    activate BController

    BController -> BService: createBooking(bookingDto)
    activate BService
    note right of BService: Bắt đầu xử lý logic nghiệp vụ

    BService -> FService: checkAvailability(fieldId, time)
    activate FService
    FService --> BService: (true) Sân còn trống
    deactivate FService

    BService -> DB: Tạo Booking (status="PENDING")
    activate DB
    DB --> BService: bookingEntity (đã lưu)
    deactivate DB

    BService -> PService: initiatePayment(bookingEntity)
    activate PService

    PService -> PaymentGateway: Yêu cầu tạo giao dịch thanh toán
    activate PaymentGateway
    PaymentGateway --> PService: paymentUrl
    deactivate PaymentGateway

    PService --> BService: paymentUrl
    deactivate PService

    BService --> BController: { bookingId, paymentUrl }
    deactivate BService

    BController --> Member: 201 Created (Chuyển hướng đến trang thanh toán)
    deactivate BController
end

... Vài phút sau: Người dùng thanh toán thành công trên trang của cổng thanh toán ...

group Luồng Hệ thống Xác nhận Thanh toán (Webhook/Callback)

    PaymentGateway -> PController: Gửi thông báo thanh toán thành công (POST /payments/webhook)
    activate PController

    PController -> PService: handleSuccessfulPayment(paymentData)
    activate PService

    PService -> DB: Cập nhật Payment (status="SUCCESS")
    activate DB
    DB --> PService: paymentEntity (đã cập nhật)
    deactivate DB

    PService -> BService: confirmBooking(bookingId)
    activate BService

    BService -> DB: Tìm Booking theo bookingId
    activate DB
    DB --> BService: bookingToConfirm
    deactivate DB

    ' --- SỬA LỖI Ở ĐÂY ---
    ' Hành động gọi phương thức của Rich Domain Object là một xử lý nội bộ của Service
    BService -> BService: bookingToConfirm.confirm()
    note right of BService: Gọi phương thức của Rich Domain Object\nđể đóng gói và thực thi logic nghiệp vụ

    BService -> DB: Cập nhật Booking (status="CONFIRMED")

    BService -> NotiService: sendBookingConfirmation(bookingToConfirm)
    activate NotiService
    note right of NotiService: Gửi email/SMS xác nhận cho khách hàng
    NotiService --> BService
    deactivate NotiService

    deactivate BService
    PService --> PController
    deactivate PService

    PController --> PaymentGateway: 200 OK (Phản hồi đã nhận webhook)
    deactivate PController
end

@enduml