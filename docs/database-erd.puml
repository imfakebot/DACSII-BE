@startuml ERD
' ERD CHI TIẾT - HỆ THỐNG ĐẶT SÂN BÓNG ĐÁ (ĐÃ CẬP NHẬT)

title Sơ đồ Quan hệ Thực thể - Hệ thống Đặt sân bóng đá

' --- Cấu hình giao diện ERD ---
hide circle
skinparam linetype ortho
skinparam tableBackgroundColor #White
skinparam tableBorderColor #5E81AC
skinparam shadowing false
skinparam packageBackgroundColor #ECEFF4
skinparam packageBorderColor #D8DEE9
skinparam tableAttributeFontSize 12


' ========================================
package "1. KHỐI QUẢN LÝ USER & PHÂN QUYỀN" {
    entity "UserProfiles" as UP {
      + **id** (PK) : VARCHAR(36)
      --
      full_name : VARCHAR(100)
      date_of_birth : DATE
      gender : ENUM
      phone_number : VARCHAR(15)
      avatar_url : TEXT
      bio : TEXT
      is_profile_completed : BOOLEAN
      created_at : TIMESTAMP
      updated_at : TIMESTAMP
      --
      # //address_id// (FK) : VARCHAR(36)
    }

    entity "Roles" as ROL {
      + **id** (PK) : INT
      --
      name : VARCHAR(50)
    }

    entity "Accounts" as AC {
      + **id** (PK) : VARCHAR(36)
      --
      email : VARCHAR(255)
      password_hash : VARCHAR(255)
      provider : VARCHAR(50)
      status : VARCHAR(20)
      is_verified : BOOLEAN
      --
      # //user_profile_id// (FK) : VARCHAR(36)
      # //role_id// (FK) : INT
    }
}

' ========================================
package "2. KHỐI QUẢN LÝ SÂN BÓNG & VỊ TRÍ" {
    entity "Cities" as C {
      + **id** (PK) : INT
      --
      name : VARCHAR(100)
    }
    entity "Wards" as W {
      + **id** (PK) : INT
      --
      name : VARCHAR(100)
      --
      # //city_id// (FK) : INT
    }

    entity "Addresses" as ADDR {
      + **id** (PK) : VARCHAR(36)
      --
      street : VARCHAR(255)
      --
      # //ward_id// (FK) : INT
    }

    entity "Utilities" as UT {
      + **id** (PK) : INT
      --
      name : VARCHAR(100)
    }

    entity "FieldTypes" as FT {
      + **id** (PK) : VARCHAR(36)
      --
      name : VARCHAR(50)
    }

    entity "Fields" as F {
      + **id** (PK) : VARCHAR(36)
      --
      name : VARCHAR(150)
      status : BOOLEAN
      --
      # //field_type_id// (FK) : VARCHAR(36)
      # //address_id// (FK) : VARCHAR(36)
      # //owner_id// (FK) : VARCHAR(36)
    }

    entity "FieldImages" as FI {
      + **id** (PK) : VARCHAR(36)
      --
      image_url : TEXT
      is_cover : BOOLEAN
      --
      # //field_id// (FK) : VARCHAR(36)
    }

    entity "Field_Utilities" as FU {
      + **//field_id//** (PFK) : VARCHAR(36)
      + **//utility_id//** (PFK) : INT
    }
}

' ========================================
package "3. KHỐI QUẢN LÝ ĐẶT SÂN & GIÁ CẢ" {
    entity "TimeSlots" as TS {
      + **id** (PK) : INT
      --
      start_time : TIME
      end_time : TIME
      price : DECIMAL
      --
      # //field_type_id// (FK) : VARCHAR(36)
    }

    entity "Bookings" as B {
      + **id** (PK) : VARCHAR(36)
      --
      booking_date : DATE
      total_price : DECIMAL
      status : ENUM
      --
      # //user_profile_id// (FK) : VARCHAR(36)
      # //field_id// (FK) : VARCHAR(36)
      # //time_slot_id// (FK) : INT
    }
}

' ========================================
package "4. KHỐI QUẢN LÝ THANH TOÁN & KHUYẾN MÃI" {
    entity "Vouchers" as V {
      + **id** (PK) : VARCHAR(36)
      --
      code : VARCHAR(50)
      ...
    }

    entity "Payments" as P {
      + **id** (PK) : VARCHAR(36)
      --
      amount : DECIMAL
      status : ENUM
      --
      # //booking_id// (FK) : VARCHAR(36)
      # //voucher_id// (FK) : VARCHAR(36)
    }
}

' ========================================
package "5. KHỐI HỖ TRỢ & PHẢN HỒI" {
    entity "Reviews" as REV {
      + **id** (PK) : VARCHAR(36)
      --
      rating : INT
      comment : TEXT
      --
      # //booking_id// (FK) : VARCHAR(36)
    }
    
    entity "Notifications" as NOTI {
      + **id** (PK) : VARCHAR(36)
      --
      title : VARCHAR(255)
      is_read : BOOLEAN
      --
      # //recipient_id// (FK) : VARCHAR(36)
    }

    entity "Feedbacks" as FB {
      + **id** (PK) : VARCHAR(36)
      --
      title : VARCHAR(255)
      --
      # //submitter_id// (FK) : VARCHAR(36)
      # //assignee_id// (FK) : VARCHAR(36)
    }
    
    entity "FeedbackResponses" as FBR {
      + **id** (PK) : VARCHAR(36)
      --
      content : TEXT
      --
      # //feedback_id// (FK) : VARCHAR(36)
      # //responder_id// (FK) : VARCHAR(36)
    }
}


' --- ĐỊNH NGHĨA CÁC MỐI QUAN HỆ ĐÃ CẬP NHẬT ---

' Khối 1
AC ||--|| UP : "has"
ROL ||--o{ AC : "defines"

' Khối 2
C  ||--o{ W
W  ||--o{ ADDR
F }o--|| ADDR : "located at"
UP }o..|| ADDR : "resides at"
FT ||--o{ F : "categorizes"
F  ||--o{ FI : "has"
F  }|..|{ FU
UT }|..|{ FU
UP }o--|| F : "owns"

' Khối 3
FT ||--o{ TS : "has pricing for"
UP }o--|| B : "makes"
F  }o--|| B : "is for"
TS }o--|| B : "at"

' Khối 4
B  ||--o{ P : "has" ' Một booking có thể có nhiều payment (đặt cọc, thanh toán đủ)
V  }o--o{ P : "applies" ' Một voucher có thể áp dụng cho nhiều payment

' Khối 5
B ||--|| REV : "has" ' Một booking chỉ có một review
UP ||--o{ NOTI : "receives"
UP ||--o{ FB : "submits"
UP }o--o{ FB : "assigned to"
FB ||--o{ FBR : "has"
UP ||--o{ FBR : "responds"

@enduml