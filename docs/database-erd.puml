@startuml ERD
' ERD CHI TIẾT NHẤT - HỆ THỐNG ĐẶT SÂN BÓNG ĐÁ (ĐÃ SỬA LỖI CÚ PHÁP LẦN 3)

title Sơ đồ Quan hệ Thực thể - Hệ thống Đặt sân bóng đá

' --- Cấu hình giao diện ERD ---
hide circle
skinparam linetype ortho
skinparam tableBackgroundColor #White
skinparam tableBorderColor #5E81AC
skinparam shadowing false
skinparam packageBackgroundColor #ECEFF4
skinparam packageBorderColor #D8DEE9
skinparam tableAttributeFontSize 12


' ========================================
package "1. KHỐI QUẢN LÝ USER & PHÂN QUYỀN" {
    entity "UserProfiles" as UP {
      + **id** (PK) : VARCHAR
      --
      fullName : VARCHAR
      dateOfBirth : DATE
      gender : VARCHAR
      phoneNumber : VARCHAR
      avatarUrl : TEXT
      bio : TEXT
      createdAt : DATETIME
      --
      # //addressId// (FK) : VARCHAR
    }

    entity "Roles" as ROL {
      + **id** (PK) : INT
      --
      name : VARCHAR
    }

    entity "Accounts" as AC {
      + **id** (PK) : VARCHAR
      --
      email : VARCHAR
      passwordHash : VARCHAR
      provider : VARCHAR
      status : VARCHAR
      isVerified : BOOLEAN
      lastLogin : DATETIME
      twoFactorEnabled : BOOLEAN
      twoFactorSecret : VARCHAR
      twoFactorRecoveryCodes : TEXT
      --
      # //userProfileId// (FK) : VARCHAR
      # //roleId// (FK) : INT
    }
}

' ========================================
package "2. KHỐI QUẢN LÝ SÂN BÓNG & VỊ TRÍ" {
    ' --- SỬA LỖI Ở ĐÂY: Tách các thuộc tính ra nhiều dòng ---
    entity "Cities" as C {
      + **id** (PK) : INT
      --
      name : VARCHAR
      type : VARCHAR
    }
    entity "Wards" as W {
      + **id** (PK) : INT
      --
      name : VARCHAR
      type : VARCHAR
      --
      # //cityId// (FK) : INT
    }

    entity "Addresses" as ADDR {
      + **id** (PK) : VARCHAR
      --
      street : VARCHAR
      --
      # //wardId// (FK) : INT
      # //cityId// (FK) : INT
    }

    entity "Utilities" as UT {
      + **id** (PK) : INT
      --
      name : VARCHAR
      iconUrl : TEXT
    }

    entity "FieldTypes" as FT {
      + **id** (PK) : VARCHAR
      --
      name : VARCHAR
      description : TEXT
    }

    entity "Fields" as F {
      + **id** (PK) : VARCHAR
      --
      name : VARCHAR
      description : TEXT
      status : VARCHAR
      --
      # //fieldTypeId// (FK) : VARCHAR
      # //addressId// (FK) : VARCHAR
    }

    entity "FieldImages" as FI {
      + **id** (PK) : VARCHAR
      --
      imageUrl : TEXT
      isCover : BOOLEAN
      --
      # //fieldId// (FK) : VARCHAR
    }

    entity "Field_Utilities" as FU {
      + **//fieldId//** (PFK) : VARCHAR
      + **//utilityId//** (PFK) : INT
    }
}

' ========================================
package "3. KHỐI QUẢN LÝ ĐẶT SÂN & GIÁ CẢ" {
    entity "TimeSlots" as TS {
      + **id** (PK) : INT
      --
      startTime : TIME
      endTime : TIME
      price : DECIMAL
      isPeakHour : BOOLEAN
      --
      # //fieldTypeId// (FK) : VARCHAR
    }

    entity "Bookings" as B {
      + **id** (PK) : VARCHAR
      --
      bookingDate : DATE
      totalPrice : DECIMAL
      status : VARCHAR
      createdAt : DATETIME
      --
      # //userProfileId// (FK) : VARCHAR
      # //fieldId// (FK) : VARCHAR
      # //timeSlotId// (FK) : INT
    }
}

' ========================================
package "4. KHỐI QUẢN LÝ THANH TOÁN & KHUYẾN MÃI" {
    entity "Vouchers" as V {
      + **id** (PK) : VARCHAR
      --
      code : VARCHAR
      discountAmount : DECIMAL
      discountPercentage : INT
      validTo : DATETIME
    }

    entity "Payments" as P {
      + **id** (PK) : VARCHAR
      --
      amount : DECIMAL
      finalAmount : DECIMAL
      status : VARCHAR
      paymentMethod : VARCHAR
      --
      # //bookingId// (FK) : VARCHAR
      # //voucherId// (FK) : VARCHAR
    }
}

' ========================================
package "5. KHỐI HỖ TRỢ & PHẢN HỒI" {
    entity "Reviews" as REV {
      + **id** (PK) : VARCHAR
      --
      rating : INT
      comment : TEXT
      --
      # //userProfileId// (FK) : VARCHAR
      # //fieldId// (FK) : VARCHAR
    }
    
    entity "Notifications" as NOTI {
      + **id** (PK) : VARCHAR
      --
      title : VARCHAR
      content : TEXT
      isRead : BOOLEAN
      --
      # //recipientId// (FK) : VARCHAR
    }

    entity "Feedbacks" as FB {
      + **id** (PK) : VARCHAR
      --
      title : VARCHAR
      category : VARCHAR
      status : VARCHAR
      --
      # //submitterId// (FK) : VARCHAR
      # //assigneeId// (FK) : VARCHAR
    }
    
    entity "FeedbackResponses" as FBR {
      + **id** (PK) : VARCHAR
      --
      content : TEXT
      --
      # //feedbackId// (FK) : VARCHAR
      # //responderId// (FK) : VARCHAR
    }
}


' --- ĐỊNH NGHĨA CÁC ĐƯỜNG NỐI (MỐI QUAN HỆ) - PHIÊN BẢN NHẤT QUÁN ---

' Khối 1
AC ||--|| UP : has
ROL ||--o{ AC : defines

' Khối 2
C ||--o{ W
W ||--o{ ADDR
ADDR ||--|| F
UP }o--|| ADDR : "resides at"
FT ||--o{ F : categorizes
F ||--o{ FI : has
F }|..|{ FU
UT }|..|{ FU

' Khối 3
FT ||--o{ TS : has pricing for
UP }o--|| B : makes
F  }o--|| B : is for
TS }o--|| B : at

' Khối 4
B ||--|| P : requires
V }o--|| P : applies

' Khối 5
UP }o--|| REV : writes
F  }o--|| REV : receives
UP ||--o{ NOTI : receives
UP ||--o{ FB : submits
UP }o--o{ FB : "assigned to"
FB ||--o{ FBR : has
UP ||--o{ FBR : responds

@enduml