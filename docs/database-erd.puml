@startuml
!theme plain
hide circle
skinparam linetype ortho

' --- NHÓM 1: ĐỊA CHÍNH (LOCATION) ---
package "Location Module" {
  entity "cities" {
    *id : int <<PK>>
    --
    name : varchar
    type : varchar
  }

  entity "wards" {
    *id : int <<PK>>
    --
    name : varchar
    type : varchar
    *city_id : int <<FK>>
  }

  entity "addresses" {
    *id : varchar <<PK>>
    --
    street : varchar
    latitude : decimal
    longitude : decimal
    *ward_id : int <<FK>>
    *cityId : int <<FK>>
  }
}

' --- NHÓM 2: NGƯỜI DÙNG & PHÂN QUYỀN (AUTH) ---
package "Auth Module" {
  entity "roles" {
    *id : int <<PK>>
    --
    name : varchar
  }

  entity "accounts" {
    *id : varchar <<PK>>
    --
    email : varchar
    password_hash : varchar
    status : varchar
    *user_profile_id : varchar <<FK>>
    *role_id : int <<FK>>
  }

  entity "user_profiles" {
    *id : varchar <<PK>>
    --
    full_name : varchar
    phone_number : varchar
    avatar_url : text
    branch_id : varchar <<FK>>
  }
}

' --- NHÓM 3: CHI NHÁNH & SÂN BÃI (FACILITY) ---
package "Facility Module" {
  entity "branches" {
    *id : varchar <<PK>>
    --
    name : varchar
    open_time : time
    close_time : time
    status : tinyint
    *address_id : varchar <<FK>>
    *manager_id : varchar <<FK>>
  }

  entity "field_types" {
    *id : varchar <<PK>>
    --
    name : varchar
    description : text
  }

  entity "fields" {
    *id : varchar <<PK>>
    --
    name : varchar
    status : tinyint
    *branch_id : varchar <<FK>>
    *field_type_id : varchar <<FK>>
  }

  entity "field_images" {
    *id : varchar <<PK>>
    --
    image_url : text
    is_cover : tinyint
    *field_id : varchar <<FK>>
  }

  entity "time_slots" {
    *id : int <<PK>>
    --
    start_time : time
    end_time : time
    price : decimal
    is_peak_hour : tinyint
    *field_type_id : varchar <<FK>>
  }
}

' --- NHÓM 4: DỊCH VỤ & TIỆN ÍCH (CANTEEN/UTILITY) ---
package "Utility & Canteen Module" {
  entity "utilities" {
    *id : int <<PK>>
    --
    name : varchar
    price : decimal
    type : enum('amenity','product')
  }

  entity "field_utilities" {
    *field_id : varchar <<PK, FK>>
    *utility_id : int <<PK, FK>>
  }

  entity "utility_sales" {
    *id : varchar <<PK>>
    --
    quantity : int
    total_price : decimal
    *utility_id : int <<FK>>
    *branch_id : varchar <<FK>>
    *booking_id : varchar <<FK>>
    *sold_by_id : varchar <<FK>>
  }
}

' --- NHÓM 5: ĐẶT SÂN & THANH TOÁN (CORE) ---
package "Booking Core" {
  entity "bookings" {
    *id : varchar <<PK>>
    --
    code : varchar
    booking_date : date
    start_time : datetime
    end_time : datetime
    total_price : decimal
    status : enum
    check_in_at : timestamp
    *user_profile_id : varchar <<FK>>
    *field_id : varchar <<FK>>
  }

  entity "vouchers" {
    *id : varchar <<PK>>
    --
    code : varchar
    discount_amount : decimal
    discount_percentage : int
  }

  entity "payments" {
    *id : varchar <<PK>>
    --
    amount : decimal
    final_amount : decimal
    payment_method : enum
    status : enum
    transaction_code : varchar
    *booking_id : varchar <<FK>>
    voucher_id : varchar <<FK>>
  }
}

' --- NHÓM 6: TƯƠNG TÁC (INTERACTION) ---
package "Interaction Module" {
  entity "reviews" {
    *id : varchar <<PK>>
    --
    rating : int
    comment : text
    *booking_id : varchar <<FK, Unique>>
    *field_id : varchar <<FK>>
    *user_profile_id : varchar <<FK>>
  }

  entity "feedbacks" {
    *id : varchar <<PK>>
    --
    title : varchar
    status : varchar
    *submitter_id : varchar <<FK>>
    assignee_id : varchar <<FK>>
  }

  entity "feedback_responses" {
    *id : varchar <<PK>>
    --
    content : text
    *feedback_id : varchar <<FK>>
    *responder_id : varchar <<FK>>
  }

  entity "notifications" {
    *id : varchar <<PK>>
    --
    title : varchar
    content : text
    *recipient_id : varchar <<FK>>
  }
}

' --- QUAN HỆ (RELATIONSHIPS) ---

' Location Relationships
cities ||..|{ wards
cities ||..|{ addresses
wards ||..|{ addresses

' Auth Relationships
roles ||..|{ accounts
user_profiles ||..|| accounts : "1-1"
branches |o..|{ user_profiles : "Employee Of"

' Facility Relationships
addresses ||..|| branches : "Located At"
user_profiles ||..|{ branches : "Manages"
branches ||..|{ fields
field_types ||..|{ fields
field_types ||..|{ time_slots
fields ||..|{ field_images

' Utility Relationships
fields ||..|{ field_utilities
utilities ||..|{ field_utilities
utilities ||..|{ utility_sales
branches ||..|{ utility_sales
bookings |o..|{ utility_sales
user_profiles ||..|{ utility_sales : "Sold By"

' Booking Relationships
user_profiles ||..|{ bookings : "Makes"
fields ||..|{ bookings
bookings ||..|| payments : "1-1"
vouchers |o..|{ payments

' Interaction Relationships
bookings ||..|| reviews : "1-1"
fields ||..|{ reviews
user_profiles ||..|{ reviews
user_profiles ||..|{ feedbacks : "Submits"
user_profiles ||..|{ feedbacks : "Assigned"
feedbacks ||..|{ feedback_responses
user_profiles ||..|{ feedback_responses
user_profiles ||..|{ notifications

@enduml